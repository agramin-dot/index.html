<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پاسخنامه یک‌صفحه‌ای واقعی</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            direction: rtl;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(to right, #4a00e0, #8e2de2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .tabs {
            display: flex;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: #e9ecef;
            cursor: pointer;
            font-weight: bold;
        }

        .tab-btn.active {
            background: white;
            color: #4a00e0;
            border-bottom: 3px solid #4a00e0;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        #camera-view {
            width: 100%;
            height: 400px;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #4a00e0;
            color: white;
        }

        .btn-success {
            background: #00b09b;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .results-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            display: none;
        }

        .answer-item {
            display: inline-block;
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .correct {
            background: #d4edda;
            color: #155724;
        }

        .incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .empty {
            background: #f8f9fa;
            color: #6c757d;
        }

        /* چاپ A5 یک‌صفحه‌ای */
        .a5-container {
            width: 148mm;
            height: 210mm;
            padding: 8mm;
            margin: auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            page-break-inside: avoid;
            box-sizing: border-box;
        }

        .sheet-marker {
            position: absolute;
            width: 15px;
            height: 15px;
            background: black;
            border: 2px solid white;
            box-shadow: 0 0 0 2px black;
            z-index: 10;
        }

        .sheet-marker.tl { top: 5mm; left: 5mm; }
        .sheet-marker.tr { top: 5mm; right: 5mm; }
        .sheet-marker.bl { bottom: 5mm; left: 5mm; }
        .sheet-marker.br { bottom: 5mm; right: 5mm; }

        .student-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
        }

        .info-item label {
            width: 100px;
            font-weight: bold;
        }

        .info-item span {
            flex: 1;
            border-bottom: 1px dashed #999;
            height: 18px;
        }

        .questions-two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .question-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 12px;
        }

        .option-bubble {
            width: 18px;
            height: 18px;
            border: 1.5px solid #333;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            margin-left: 4px;
        }

        .option-bubble.filled::after {
            content: '';
            width: 12px;
            height: 12px;
            background: black;
            border-radius: 50%;
        }

        .results-summary {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
            font-size: 12px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dashed #ccc;
        }

        .teacher-signature {
            margin-top: 10px;
            text-align: left;
            font-size: 12px;
        }

        @media print {
            body > *:not(#print-container) {
                display: none !important;
            }

            #print-container {
                display: block !important;
                background: white !important;
            }

            .a5-container {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 8mm !important;
                border: none !important;
            }

            .sheet-marker {
                background: black !important;
                border: 2px solid black !important;
                box-shadow: none !important;
            }

            .option-bubble {
                border-color: black !important;
            }

            .option-bubble.filled::after {
                background: black !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>پاسخنامه یک‌صفحه‌ای واقعی</h1>
            <p>با OCR واقعی و چاپ یک‌صفحه‌ای</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('app')">تصحیح پاسخنامه</button>
            <button class="tab-btn" onclick="openTab('sheet')">چاپ پاسخنامه</button>
        </div>

        <div id="app" class="tab-content active">
            <h3>انتخاب آزمون</h3>
            <select id="exam-select">
                <option value="">-- انتخاب کنید --</option>
                <option value="1">ریاضی - 20 سوال</option>
                <option value="2">علوم - 30 سوال</option>
            </select>

            <h3>تصویربرداری</h3>
            <div id="camera-view">
                <div>دوربین خاموش است</div>
            </div>
            <div class="controls">
                <button class="btn-primary" onclick="startCamera()">روشن کردن دوربین</button>
                <button class="btn-success" onclick="captureImage()">عکس‌برداری و تصحیح</button>
                <button class="btn-danger" onclick="resetCamera()">بازنشانی</button>
            </div>

            <div class="results-section" id="results">
                <h3>نتایج تصحیح</h3>
                <div id="answers"></div>
            </div>
        </div>

        <div id="sheet" class="tab-content">
            <button class="btn-secondary" onclick="printAnswerSheet()">چاپ پاسخنامه یک‌صفحه‌ای</button>
            <div class="a5-container" id="sheet-template">
                <div class="sheet-marker tl"></div>
                <div class="sheet-marker tr"></div>
                <div class="sheet-marker bl"></div>
                <div class="sheet-marker br"></div>

                <div class="school-name">دبیرستان نمونه دولتی امام صادق</div>

                <div style="text-align:center; margin-bottom: 10px;">
                    <h3>آزمون پایانی ریاضی</h3>
                    <p>درس: ریاضی عمومی | تاریخ: ۱۴۰۳/۰۳/۱۵</p>
                </div>

                <div class="student-info">
                    <div class="info-item"><label>نام و نام خانوادگی:</label><span></span></div>
                    <div class="info-item"><label>رشته تحصیلی:</label><span></span></div>
                    <div class="info-item"><label>شعبه کلاس:</label><span></span></div>
                    <div class="info-item"><label>کد ملی:</label><span></span></div>
                </div>

                <div class="questions-two-column" id="questions-box"></div>

                <div class="results-summary">
                    <h4>نتایج تصحیح خودکار</h4>
                    <div class="summary-grid">
                        <div class="summary-item"><span>پاسخ درست:</span><span id="correct-count">۰</span></div>
                        <div class="summary-item"><span>پاسخ نادرست:</span><span id="wrong-count">۰</span></div>
                        <div class="summary-item"><span>بی‌پاسخ:</span><span id="empty-count">۰</span></div>
                        <div class="summary-item"><span>نمره (از ۲۰):</span><span id="final-score">۰</span></div>
                    </div>
                    <div class="teacher-signature">امضای دبیر: ......................</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedExam = null;
        let video = null;
        let stream = null;

        const exams = {
            1: { name: 'ریاضی', count: 20, key: ['الف', 'ب', 'ج', 'د', 'الف', 'ب', 'ج', 'د', 'الف', 'ب', 'ج', 'د', 'الف', 'ب', 'ج', 'د', 'الف', 'ب', 'ج', 'د'] },
            2: { name: 'علوم', count: 30, key: ['ب', 'ج', 'الف', 'د', 'ب', 'ج', 'الف', 'د', 'ب', 'ج', 'الف', 'د', 'ب', 'ج', 'الف', 'د', 'ب', 'ج', 'الف', 'د', 'ب', 'ج', 'الف', 'د', 'ب', 'ج', 'الف', 'د', 'ب', 'ج'] }
        };

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(s => {
                    stream = s;
                    video = document.createElement('video');
                    video.srcObject = stream;
                    video.autoplay = true;
                    document.getElementById('camera-view').innerHTML = '';
                    document.getElementById('camera-view').appendChild(video);
                })
                .catch(err => alert('دسترسی به دوربین ممکن نیست'));
        }

        function resetCamera() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                document.getElementById('camera-view').innerHTML = '<div>دوربین خاموش است</div>';
            }
        }

        function captureImage() {
            if (!video) return alert('ابتدا دوربین را روشن کنید');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg');

            const examId = document.getElementById('exam-select').value;
            selectedExam = exams[examId];
            if (!selectedExam) return alert('آزمونی انتخاب نشده');

            processImageWithOCR(imageData);
        }

        async function processImageWithOCR(imageData) {
            const img = new Image();
            img.src = imageData;
            img.onload = async () => {
                const result = await Tesseract.recognize(img, 'fas', { logger: m => console.log(m) });
                const text = result.data.text;
                const studentAnswers = extractAnswersFromText(text);
                const grading = gradeExam(studentAnswers, selectedExam.key);
                displayResults(grading);
            };
        }

        function extractAnswersFromText(text) {
            const answers = [];
            const lines = text.split('\n');
            lines.forEach(line => {
                const match = line.match(/(\d+)\s*[:.-]\s*([الفبجد])/);
                if (match) {
                    const q = parseInt(match[1]);
                    answers[q - 1] = match[2];
                }
            });
            for (let i = 0; i < selectedExam.count; i++) {
                if (!answers[i]) answers[i] = '';
            }
            return answers.slice(0, selectedExam.count);
        }

        function gradeExam(student, key) {
            const result = [];
            let correct = 0, wrong = 0, empty = 0;
            for (let i = 0; i < key.length; i++) {
                const status = student[i] === '' ? 'empty' : (student[i] === key[i] ? 'correct' : 'incorrect');
                if (status === 'correct') correct++;
                else if (status === 'incorrect') wrong++;
                else empty++;
                result.push({ q: i + 1, status });
            }
            return { result, correct, wrong, empty };
        }

        function displayResults(grading) {
            const div = document.getElementById('answers');
            div.innerHTML = '';
            grading.result.forEach(r => {
                const span = document.createElement('span');
                span.className = `answer-item ${r.status}`;
                span.textContent = r.q;
                div.appendChild(span);
            });
            div.innerHTML += `<br>درست: ${grading.correct} | نادرست: ${grading.wrong} | بی‌پاسخ: ${grading.empty}`;
            document.getElementById('results').style.display = 'block';
        }

        function generateQuestions(count) {
            const container = document.getElementById('questions-box');
            container.innerHTML = '';
            const options = ['الف', 'ب', 'ج', 'د'];
            for (let i = 1; i <= count; i++) {
                const row = document.createElement('div');
                row.className = 'question-item';
                row.innerHTML = `
                    <span>سوال ${i}</span>
                    <div>
                        ${options.map(o => `<span class="option-bubble">${o}</span>`).join('')}
                    </div>
                `;
                container.appendChild(row);
            }
        }

        function printAnswerSheet() {
            generateQuestions(20);
            const printContainer = document.createElement('div');
            printContainer.id = 'print-container';
            const sheet = document.getElementById('sheet-template').cloneNode(true);
            printContainer.appendChild(sheet);
            document.body.appendChild(printContainer);
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    if (document.body.contains(printContainer)) {
                        document.body.removeChild(printContainer);
                    }
                }, 100);
            }, 500);
        }

        generateQuestions(20);
    </script>
</body>
</html>
