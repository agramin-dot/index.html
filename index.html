<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Grader V4 – واقعی و تست‌شده</title>
  <meta name="color-scheme" content="light dark"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdyYWRlciBWNCBPbWlkIiwKICAic2hvcnRfbmFtZSI6ICJHcmFkZXI0IiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjNGEwMGUwIgp9">
  <style>
    :root{--primary:#4a00e0;--muted:#555;--bg:#f3f6ff;--surface:#fff}
    @media(prefers-color-scheme:dark){:root{--bg:#121212;--surface:#1e1e1e;--muted:#bbb}}
    *{box-sizing:border-box;font-family:"Segoe UI",Tahoma,Arial,sans-serif}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--muted)}
    .container{max-width:1200px;margin:18px auto;padding:16px;border-radius:12px;background:var(--surface);box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .header{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,var(--primary),#8e2de2);display:grid;place-content:center;color:#fff;font-weight:700}
    h1{font-size:1.25rem;margin:0}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:#fafbff;padding:12px;border-radius:10px;border:1px solid #e6e6f2}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:#fff;border:1px solid #d0d0e4;color:var(--primary)}
    .small{padding:6px 8px;font-size:.9rem}
    .camera-box{height:320px;border-radius:8px;overflow:hidden;background:#000;position:relative;display:flex;align-items:center;justify-content:center}
    .camera-video,.camera-canvas,.camera-preview{width:100%;height:100%;object-fit:contain;display:block}
    .overlay{position:absolute;inset:0;pointer-events:none;border:2px dashed #0ff;box-sizing:border-box}
    .info{font-size:.85rem;color:var(--muted);margin-top:8px}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .form-row label{min-width:110px;font-weight:700;font-size:.9rem}
    .form-row input,.form-row select{flex:1;padding:8px;border:1px solid #e9e9f6;border-radius:6px}
    #answers-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(54px,1fr));gap:8px;margin-top:10px}
    .answer-item{padding:8px;border-radius:8px;text-align:center;font-weight:800;position:relative}
    .correct{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .wrong{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .empty{background:#f8f9fa;color:#6c757d;border:1px solid #e9ecef}
    .lowconf{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
    .conf{position:absolute;left:6px;bottom:6px;font-size:.75rem;opacity:.8}
    .history{margin-top:12px}
    .history-item{padding:8px;border-radius:8px;background:#fafafa;border:1px solid #f0f0f5;display:flex;justify-content:space-between;align-items:center}
    .note{font-size:.87rem}
    .footer{margin-top:14px;text-align:center;font-size:.9rem;opacity:.7}
  </style>
</head>
<body>
<div class="container" role="application">
  <div class="header">
    <div class="logo">◎</div>
    <div>
      <h1>Grader V4 – واقعی و تست‌شده</h1>
      <div class="info">OpenCV.js + jsQR • تصحیح پرسپکتیو • تشخیص حباب‌ها • خروجی Excel/PDF • PWA</div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3>⚙️ تنظیمات</h3>
      <div class="form-row">
        <label for="exam-select">آزمون</label>
        <select id="exam-select"></select>
      </div>
      <div class="controls">
        <button id="download-template" class="btn-primary small">📄 دانلود قالب چاپ پاسخ‌نامه</button>
        <button id="open-exam-editor" class="btn-ghost small">ایجاد/ویرایش آزمون</button>
        <button id="clear-exams" class="btn-ghost small">حذف همه آزمون‌ها</button>
      </div>

      <hr>

      <h4>📷 دوربین / تصویر</h4>
      <div class="controls">
        <button id="start-camera" class="btn-primary small">فعال‌سازی دوربین</button>
        <button id="stop-camera" class="btn-ghost small">توقف</button>
      </div>
      <div class="controls">
        <button id="capture-snapshot" class="btn-ghost small">عکس فوری</button>
        <label class="btn-ghost small" style="cursor:pointer">
          بارگذاری تصویر
          <input id="upload-image" type="file" accept="image/*" hidden>
        </label>
      </div>
      <div class="info">نور یکنواخت، ۴ نشانگر سیاه در گوشه‌ها، فاصله ۲۵ cm، کد QR بالا-چپ</div>

      <hr>

      <h4>🔧 پارامترهای پردازش</h4>
      <div class="form-row">
        <label for="q-count">تعداد سؤال</label>
        <input id="q-count" type="number" min="10" max="200" value="50">
      </div>
      <div class="form-row">
        <label for="bubble-radius">قطر حباب (mm)</label>
        <input id="bubble-radius" type="number" min="8" max="20" value="12">
      </div>
      <div class="form-row">
        <label for="fill-threshold">آستانه پرشدگی (%)</label>
        <input id="fill-threshold" type="number" min="20" max="80" value="45">
      </div>

      <div class="controls">
        <button id="auto-scan" class="btn-primary small">🤖 اسکن خودکار (۶ فریم)</button>
        <button id="process-image" class="btn-ghost small">⚙️ پردازش تصویر</button>
      </div>

      <div class="controls">
        <button id="export-csv" class="btn-ghost small">⬇️ دانلود Excel</button>
        <button id="print-results" class="btn-ghost small">🖨️ چاپ کارنامه</button>
      </div>

      <div class="history">
        <h4>🕒 تاریخچه</h4>
        <div id="history-list"></div>
      </div>
    </div>

    <div>
      <div class="panel">
        <h3>📸 پیش‌نمایش</h3>
        <div class="camera-box" id="camera-box">
          <video id="camera-video" class="camera-video" autoplay playsinline hidden></video>
          <canvas id="camera-canvas" class="camera-canvas" hidden></canvas>
          <img id="camera-preview" class="camera-preview" hidden alt="پیش‌نمایش">
          <div class="overlay" id="overlay"></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="note" id="status">وضعیت: در حال بارگذاری OpenCV...</div>
          <div class="controls">
            <button id="detect-markers" class="btn-ghost small">🔍 تشخیص نشانگرها</button>
            <button id="detect-qr" class="btn-ghost small">📇 خواندن QR</button>
          </div>
        </div>
        <div class="note">شناسه دانش‌آموز: <span id="student-id">—</span></div>
        <label><input type="checkbox" id="manual-check" disabled> ⚠️ نیاز به بررسی دستی</label>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>📊 نتایج</h3>
        <div class="note">آزمون: <span id="selected-exam-name">—</span> – تعداد سؤال: <span id="selected-qcount">۰</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="font-weight:800;font-size:1.3rem" id="final-score">۰</div>
          <div class="note">دقت برآوردی: <span id="detected-confidence">—</span>%</div>
        </div>
        <div id="answers-grid"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="toggle-details" class="btn-ghost small">نمایش جزئیات</button>
          <button id="regrade" class="btn-ghost small">بازنمره (Regrade)</button>
          <span class="note" style="margin-right:auto">خروجی: <span id="export-info">—</span></span>
        </div>
        <div id="details" style="margin-top:10px;display:none;font-size:.9rem"></div>
      </div>
    </div>
  </div>

  <div class="footer">نسخه ۴ – PWA – بدون نیاز به اینترنت پس از بارگذاری اولیه – ساخته شده با ❤️</div>
</div>

<script src="https://docs.opencv.org/4.8.0/opencv.js" async></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ========== Constants ========== */
const EXAMS_KEY='grader_v4_exams',HISTORY_KEY='grader_v4_history',DB_NAME='grader';
let cvReady=false,stream=null,lastGrading=null;
const el=id=>document.getElementById(id);
const toPersian=n=>String(n).replace(/\d/g,d=>'۰۱۲۳۴۵۶۷۸۹'[d]);
const now=()=>new Date().toLocaleString('fa-IR');

/* ========== Storage ========== */
let exams=JSON.parse(localStorage.getItem(EXAMS_KEY)||'[]');
function saveExams(){localStorage.setItem(EXAMS_KEY,JSON.stringify(exams));refreshExamSelect();}
function refreshExamSelect(){
  const s=el('exam-select');s.innerHTML='<option value="">-- انتخاب آزمون --</option>';
  exams.forEach(e=>{
    const o=document.createElement('option');o.value=e.id;o.textContent=`${e.name} (${e.course})`;
    s.appendChild(o);
  });
  if(exams.length&&!s.value){s.value=exams[0].id;}
  updateSelectedDisplay();
}
function updateSelectedDisplay(){
  const e=exams.find(x=>x.id===el('exam-select').value);
  if(e){el('selected-exam-name').textContent=e.name;el('selected-qcount').textContent=toPersian(e.questionCount);}
}

/* ========== History ========== */
function pushHistory(entry){
  const arr=JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
  arr.push(entry);
  localStorage.setItem(HISTORY_KEY,JSON.stringify(arr.slice(-200)));
  refreshHistory();
}
function refreshHistory(){
  const box=el('history-list');box.innerHTML='';
  const arr=JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
  arr.slice().reverse().forEach(h=>{
    const d=document.createElement('div');d.className='history-item';
    d.innerHTML=`<div>${h.examName} – ${h.time}</div><div><b>${toPersian(h.correct)}/${toPersian(h.total)}</b></div>`;
    box.appendChild(d);
  });
}

/* ========== Camera ========== */
async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:false});
    el('camera-video').srcObject=stream;el('camera-video').hidden=false;el('camera-preview').hidden=true;
    await el('camera-video').play();
    setStatus('دوربین فعال شد');
  }catch(err){alert('خطا در دوربین: '+err.message);}
}
function stopCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  el('camera-video').pause();el('camera-video').srcObject=null;el('camera-video').hidden=true;
  setStatus('دوربین متوقف شد');
}
function captureSnapshot(){
  const v=el('camera-video');const w=v.videoWidth||1280,h=v.videoHeight||720;
  const c=el('camera-canvas');c.width=w;c.height=h;
  const ctx=c.getContext('2d');ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h);ctx.drawImage(v,0,0,w,h);
  el('camera-preview').src=c.toDataURL('image/jpeg',.92);el('camera-preview').hidden=false;v.hidden=true;
  setStatus('عکس گرفته شد');
  return el('camera-preview').src;
}
el('upload-image').onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{el('camera-preview').src=ev.target.result;el('camera-preview').hidden=false;el('camera-video').hidden=true;setStatus('تصویر بارگذاری شد');};r.readAsDataURL(f);
};

/* ========== OpenCV Ready ========== */
function setStatus(t){el('status').textContent='وضعیت: '+t;}
function waitCV(){
  return new Promise(res=>{
    const id=setInterval(()=>{
      if(window.cv&&cv.Mat){clearInterval(id);cvReady=true;setStatus('OpenCV آماده است');res();}
    },200);
    setTimeout(()=>{if(!cvReady)setStatus('OpenCV هنوز بارگذاری نشده – اتصال را بررسی کنید');},8000);
  });
}

/* ========== Image Enhance ========== */
function enhanceGray(srcGray){
  const clahe=new cv.CLAHE(2.0,new cv.Size(8,8));
  const dst=new cv.Mat();clahe.apply(srcGray,dst);clahe.delete();return dst;
}
function autoRotate(src){
  const h=src.rows,w=src.cols;
  if(w>h){const dst=new cv.Mat();cv.rotate(src,dst,cv.
