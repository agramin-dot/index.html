<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اپلیکیشن تصحیح خودکار پاسخنامه استاندارد</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        :root{--primary:#4a00e0;--secondary:#8e2de2;--accent:#00b09b;--danger:#dc3545;--light:#f5f7fa;--dark:#333}
        body{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:var(--dark);min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
        header{background:linear-gradient(to right,var(--primary),var(--secondary));color:white;text-align:center;padding:25px 20px;position:relative}
        header h1{font-size:1.8rem;margin-bottom:10px}header p{font-size:1rem;opacity:.9}
        .tabs{display:flex;background:var(--light)}.tab-btn{flex:1;padding:15px;border:none;cursor:pointer;font-weight:600;transition:all .3s ease}
        .tab-btn.active{background:white;color:var(--primary);border-bottom:3px solid var(--primary)}
        .tab-content{display:none;padding:25px}.tab-content.active{display:block}
        #camera-view{width:100%;height:400px;background:#000;position:relative;display:flex;justify-content:center;align-items:center;color:white}
        .controls{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
        button{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
        .btn-primary{background:var(--primary);color:white}.btn-success{background:var(--accent);color:white}
        .btn-danger{background:var(--danger);color:white}.btn-secondary{background:#6c757d;color:white}
        .results-section{background:#f0f9ff;padding:20px;border-radius:10px;margin-top:20px;display:none}
        .answer-item{display:inline-block;margin:5px;padding:10px;border-radius:5px;font-weight:bold;min-width:40px;text-align:center}
        .correct{background:#d4edda;color:#155724}.incorrect{background:#f8d7da;color:#721c24}.empty{background:#f8f9fa;color:#6c757d}
        .a5-container{width:148mm;height:210mm;padding:15mm;margin:auto;background:white;box-shadow:0 0 10px rgba(0,0,0,.1);position:relative;page-break-inside:avoid;box-sizing:border-box}
        .sheet-marker{position:absolute;width:15px;height:15px;background:black;border:2px solid white;box-shadow:0 0 0 2px black;z-index:10}
        .sheet-marker.tl{top:5mm;left:5mm}.sheet-marker.tr{top:5mm;right:5mm}.sheet-marker.bl{bottom:5mm;left:5mm}.sheet-marker.br{bottom:5mm;right:5mm}
        .student-info{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:15px;font-size:14px}
        .info-item{display:flex;align-items:center}.info-item label{width:100px;font-weight:bold}.info-item span{flex:1;border-bottom:1px dashed #999;height:20px}
        .questions-grid{display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;margin-top:20px}
        .question-cell{text-align:center;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;min-height:60px;display:flex;flex-direction:column;justify-content:space-between}
        .question-number{font-weight:bold;margin-bottom:8px;font-size:16px}
        .option-bubbles{display:flex;justify-content:center;gap:5px}
        .option-bubble{width:20px;height:20px;border:1px solid #333;border-radius:50%;display:inline-flex;justify-content:center;align-items:center;font-size:12px}
        .option-bubble.filled::after{content:'';width:14px;height:14px;background:black;border-radius:50%}
        .results-summary{margin-top:10px;padding:10px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;font-size:12px}
        .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
        .file-input-container{margin:15px 0}
        .file-input-container label{display:block;margin-bottom:5px;font-weight:600}
        .file-input-container input{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
        .progress-container{margin:15px 0}
        .progress-bar{width:100%;height:20px;background:#eee;border-radius:10px;overflow:hidden}
        .progress{height:100%;background:var(--accent);width:0%;transition:width .3s}
        .status-text{margin-top:5px;font-size:.9rem;text-align:center}
        .results-table{width:100%;border-collapse:collapse;margin-top:15px}
        .results-table th,.results-table td{padding:10px;text-align:center;border:1px solid #ddd}
        .results-table th{background:var(--light)}
        .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
        .setting-item{margin-bottom:15px}
        .setting-item label{display:block;margin-bottom:5px;font-weight:600}
        .setting-item input,.setting-item select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
        .instructions{background:#f0f9ff;padding:15px;border-radius:8px;margin-top:20px;font-size:.9rem}
        .instructions ol{padding-right:20px;margin-top:10px}
        .instructions li{margin-bottom:5px}
        .manual-answers{background:#f8f9fa;padding:15px;border-radius:8px;margin-top:15px}
        .manual-answers-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));gap:10px;margin-top:10px}
        .manual-answer-item{text-align:center}
        .manual-answer-item select{width:100%;text-align:center;font-weight:bold;padding:5px}
        .camera-options{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .camera-option-btn{flex:1;min-width:120px}
        .answer-sheet-preview{text-align:center;margin:20px 0}
        .answer-sheet-preview img{max-width:100%;border:1px solid #ddd;border-radius:8px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
        .answer-inputs{display:flex;gap:10px;margin-top:10px}
        .answer-input{flex:1;text-align:center}
        .answer-input label{display:block;margin-bottom:5px;font-weight:600}
        .answer-input input,.answer-input select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;text-align:center}
        .printable-sheet{display:none}
        @media print{
            .no-print{display:none}
            body, html{width:100%;height:100%;margin:0;padding:0;background:white}
            .container{max-width:100%;box-shadow:none;border-radius:0;background:white}
            .printable-sheet{display:block;width:148mm;height:210mm;margin:0 auto}
            .a5-container{box-shadow:none;margin:0;width:100%;height:100%}
        }
        @media (max-width:768px){.tabs{flex-direction:column}.settings-grid{grid-template-columns:1fr}.questions-grid{grid-template-columns:repeat(3, 1fr)}.camera-options{flex-direction:column}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>اپلیکیشن تصحیح خودکار پاسخنامه استاندارد</h1>
            <p>با استفاده از هوش مصنوعی و پردازش تصویر، پاسخنامه‌های شما را به صورت خودکار تصحیح می‌کند</p>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="camera">دوربین</button>
            <button class="tab-btn" data-tab="upload">آپلود تصویر</button>
            <button class="tab-btn" data-tab="answers">پاسخ‌های صحیح</button>
            <button class="tab-btn" data-tab="results">نتایج</button>
            <button class="tab-btn" data-tab="settings">تنظیمات</button>
        </div>
        
        <div class="tab-content active" id="camera-tab">
            <div class="camera-options">
                <button id="start-camera-back" class="btn-primary camera-option-btn">دوربین اصلی (عقب)</button>
                <button id="start-camera-front" class="btn-secondary camera-option-btn">دوربین سلفی (جلو)</button>
            </div>
            
            <div id="camera-view">
                <p>برای شروع، دوربین را فعال کنید</p>
            </div>
            <div class="controls">
                <button id="capture-btn" class="btn-success" disabled>عکس‌برداری</button>
                <button id="stop-camera" class="btn-danger" disabled>توقف دوربین</button>
                <button id="reset-btn" class="btn-secondary">بازنشانی</button>
            </div>
            
            <div class="progress-container no-print">
                <div class="progress-bar">
                    <div class="progress" id="progress-bar"></div>
                </div>
                <div class="status-text" id="status-text">آماده</div>
            </div>
            
            <button id="process-camera" class="btn-primary" disabled>پردازش تصویر</button>
            
            <div class="answer-sheet-preview">
                <h3>پاسخنامه استاندارد</h3>
                <p>برای بهترین نتایج، از پاسخنامه استاندارد زیر استفاده کنید:</p>
                <button id="print-standard-sheet" class="btn-primary no-print">چاپ پاسخنامه استاندارد</button>
                <div id="standard-sheet-preview">
                    <!-- پاسخنامه استاندارد در اینجا نمایش داده می‌شود -->
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="upload-tab">
            <div class="file-input-container">
                <label for="image-file">آپلود تصویر پاسخنامه</label>
                <input type="file" id="image-file" accept="image/*">
            </div>
            
            <div class="progress-container no-print">
                <div class="progress-bar">
                    <div class="progress" id="progress-bar-upload"></div>
                </div>
                <div class="status-text" id="status-text-upload">آماده</div>
            </div>
            
            <button id="process-upload" class="btn-primary" disabled>پردازش تصویر</button>
        </div>
        
        <div class="tab-content" id="answers-tab">
            <div class="file-input-container">
                <label for="excel-file">آپلود فایل پاسخ‌های صحیح (Excel)</label>
                <input type="file" id="excel-file" accept=".xlsx, .xls">
            </div>
            
            <div class="manual-answers">
                <h3>ورود دستی پاسخ‌های صحیح</h3>
                <p>می‌توانید پاسخ‌های صحیح را به صورت دستی وارد کنید:</p>
                
                <div class="answer-inputs">
                    <div class="answer-input">
                        <label for="manual-answer-start">از سوال شماره</label>
                        <input type="number" id="manual-answer-start" value="1" min="1">
                    </div>
                    <div class="answer-input">
                        <label for="manual-answer-end">تا سوال شماره</label>
                        <input type="number" id="manual-answer-end" value="20" min="1">
                    </div>
                    <div class="answer-input">
                        <label for="manual-answer-value">پاسخ صحیح</label>
                        <select id="manual-answer-value">
                            <option value="">-- انتخاب کنید --</option>
                            <option value="A">الف</option>
                            <option value="B">ب</option>
                            <option value="C">ج</option>
                            <option value="D">د</option>
                        </select>
                    </div>
                </div>
                
                <button id="set-manual-answers" class="btn-primary">اعمال پاسخ‌ها</button>
                <button id="clear-manual-answers" class="btn-secondary">پاک کردن همه پاسخ‌ها</button>
            </div>
            
            <div class="manual-answers-grid" id="manual-answers-container">
                <!-- پاسخ‌های دستی در اینجا نمایش داده می‌شوند -->
            </div>
        </div>
        
        <div class="tab-content" id="results-tab">
            <div class="results-section" id="results-section">
                <h3>نتایج تصحیح</h3>
                <div id="results-container"></div>
                <button id="print-results" class="btn-primary no-print">چاپ نتایج</button>
                <button id="export-results" class="btn-success no-print">خروجی Excel</button>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="num-questions">تعداد سوالات</label>
                    <input type="number" id="num-questions" value="20" min="1" max="50">
                </div>
                <div class="setting-item">
                    <label for="options-per-question">تعداد گزینه‌های هر سوال</label>
                    <select id="options-per-question">
                        <option value="2">2 گزینه</option>
                        <option value="3">3 گزینه</option>
                        <option value="4" selected>4 گزینه</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="correct-score">نمره هر پاسخ صحیح</label>
                    <input type="number" id="correct-score" value="1" step="0.1" min="0">
                </div>
                <div class="setting-item">
                    <label for="wrong-score">نمره هر پاسخ غلط</label>
                    <input type="number" id="wrong-score" value="-0.25" step="0.1" max="0">
                </div>
            </div>
            
            <button id="save-settings" class="btn-primary">ذخیره تنظیمات</button>
            
            <div class="instructions">
                <h3>راهنمای استفاده:</h3>
                <ol>
                    <li>ابتدا تعداد سوالات و گزینه‌ها را در بخش تنظیمات مشخص کنید</li>
                    <li>پاسخ‌های صحیح را از طریق تب "پاسخ‌های صحیح" وارد کنید (اکسل یا دستی)</li>
                    <li>از طریق دوربین یا آپلود تصویر، پاسخنامه را وارد سیستم کنید</li>
                    <li>بر روی دکمه پردازش کلیک کنید تا تصحیح خودکار انجام شود</li>
                    <li>نتایج را مشاهده و در صورت نیاز چاپ یا ذخیره کنید</li>
                </ol>
            </div>
        </div>
        
        <!-- پاسخنامه استاندارد قابل چاپ -->
        <div class="printable-sheet">
            <div class="a5-container">
                <div class="sheet-marker tl"></div>
                <div class="sheet-marker tr"></div>
                <div class="sheet-marker bl"></div>
                <div class="sheet-marker br"></div>
                
                <h3 style="text-align: center; margin-bottom: 15px; font-size: 18px;">پاسخنامه استاندارد</h3>
                
                <div class="student-info">
                    <div class="info-item">
                        <label>نام دانشجو:</label>
                        <span></span>
                    </div>
                    <div class="info-item">
                        <label>شماره دانشجویی:</label>
                        <span></span>
                    </div>
                    <div class="info-item">
                        <label>تاریخ امتحان:</label>
                        <span></span>
                    </div>
                    <div class="info-item">
                        <label>درس:</label>
                        <span></span>
                    </div>
                </div>
                
                <div class="questions-grid" id="printable-questions-container">
                    <!-- سوالات به صورت دینامیک ایجاد می‌شوند -->
                </div>
                
                <div style="margin-top: 20px; text-align: center; font-size: 12px;">
                    <p>برای علامت‌گذاری پاسخ صحیح، دایره مربوط به گزینه مورد نظر را کاملاً پر کنید.</p>
                </div>
            </div>
        </div>
        
        <div class="a5-container no-print" id="answer-sheet-template" style="display: none;">
            <div class="sheet-marker tl"></div>
            <div class="sheet-marker tr"></div>
            <div class="sheet-marker bl"></div>
            <div class="sheet-marker br"></div>
            
            <h3 style="text-align: center; margin-bottom: 10px;">پاسخنامه نمونه</h3>
            
            <div class="student-info">
                <div class="info-item">
                    <label>نام دانشجو:</label>
                    <span></span>
                </div>
                <div class="info-item">
                    <label>شماره دانشجویی:</label>
                    <span></span>
                </div>
                <div class="info-item">
                    <label>تاریخ امتحان:</label>
                    <span></span>
                </div>
                <div class="info-item">
                    <label>درس:</label>
                    <span></span>
                </div>
            </div>
            
            <div class="questions-grid" id="questions-container">
                <!-- سوالات به صورت دینامیک ایجاد می‌شوند -->
            </div>
            
            <div class="results-summary">
                <h4>خلاصه نتایج:</h4>
                <div class="summary-grid">
                    <div>تعداد سوالات: <span id="total-questions">0</span></div>
                    <div>پاسخ‌های صحیح: <span id="correct-count">0</span></div>
                    <div>پاسخ‌های غلط: <span id="wrong-count">0</span></div>
                    <div>پاسخ‌های خالی: <span id="empty-count">0</span></div>
                    <div>نمره کل: <span id="total-score">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // متغیرهای جهانی
        let stream = null;
        let currentCamera = 'environment'; // پیش‌فرض دوربین عقب
        let correctAnswers = {};
        let ocrResults = {};
        let settings = {
            numQuestions: 20, // پیش‌فرض 20 سوال
            optionsPerQuestion: 4, // فقط 4 گزینه
            correctScore: 1,
            wrongScore: -0.25
        };

        // رویدادهای پس از بارگیری صفحه
        document.addEventListener('DOMContentLoaded', function() {
            // مدیریت تب‌ها
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // حذف کلاس active از همه تب‌ها
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // اضافه کردن کلاس active به تب انتخاب شده
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // بارگذاری تنظیمات از localStorage
            loadSettings();
            
            // به‌روزرسانی فرم‌های تنظیمات
            updateSettingsForm();
            
            // ایجاد نمونه پاسخنامه
            createAnswerSheetTemplate();
            createPrintableSheet();
            createStandardSheetPreview();
            createManualAnswersGrid();
            
            // رویدادهای دوربین
            document.getElementById('start-camera-back').addEventListener('click', () => startCamera('environment'));
            document.getElementById('start-camera-front').addEventListener('click', () => startCamera('user'));
            document.getElementById('stop-camera').addEventListener('click', stopCamera);
            document.getElementById('capture-btn').addEventListener('click', captureImage);
            document.getElementById('reset-btn').addEventListener('click', resetCamera);
            document.getElementById('process-camera').addEventListener('click', () => processImage('camera'));
            
            // رویدادهای آپلود
            document.getElementById('image-file').addEventListener('change', handleImageUpload);
            document.getElementById('process-upload').addEventListener('click', () => processImage('upload'));
            
            // رویدادهای پاسخ‌های صحیح
            document.getElementById('excel-file').addEventListener('change', handleExcelUpload);
            document.getElementById('set-manual-answers').addEventListener('click', setManualAnswers);
            document.getElementById('clear-manual-answers').addEventListener('click', clearManualAnswers);
            
            // رویدادهای نتایج
            document.getElementById('print-results').addEventListener('click', printResults);
            document.getElementById('export-results').addEventListener('click', exportResults);
            document.getElementById('print-standard-sheet').addEventListener('click', printStandardSheet);
            
            // رویدادهای تنظیمات
            document.getElementById('save-settings').addEventListener('click', saveSettings);
        });
        
        // توابع مربوط به دوربین
        async function startCamera(cameraType) {
            currentCamera = cameraType;
            
            try {
                const constraints = {
                    video: { 
                        facingMode: cameraType,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const cameraView = document.getElementById('camera-view');
                cameraView.innerHTML = '<video id="video" autoplay playsinline style="width:100%;height:100%;object-fit:contain;"></video>';
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // فعال/غیرفعال کردن دکمه‌ها
                document.getElementById('start-camera-back').disabled = true;
                document.getElementById('start-camera-front').disabled = true;
                document.getElementById('stop-camera').disabled = false;
                document.getElementById('capture-btn').disabled = false;
                
                // نمایش پیام راهنما
                document.getElementById('status-text').textContent = 'دوربین فعال شد. پاسخنامه را در مرکز تصویر قرار دهید.';
            } catch (err) {
                console.error('خطا در دسترسی به دوربین:', err);
                alert('دسترسی به دوربین ممکن نیست. لطفاً مجوزهای لازم را بررسی کنید.');
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            const cameraView = document.getElementById('camera-view');
            cameraView.innerHTML = '<p>دوربین متوقف شد</p>';
            
            // فعال/غیرفعال کردن دکمه‌ها
            document.getElementById('start-camera-back').disabled = false;
            document.getElementById('start-camera-front').disabled = false;
            document.getElementById('stop-camera').disabled = true;
            document.getElementById('capture-btn').disabled = true;
            document.getElementById('process-camera').disabled = true;
            
            document.getElementById('status-text').textContent = 'دوربین متوقف شد';
        }
        
        function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // نمایش تصویر گرفته شده
            const cameraView = document.getElementById('camera-view');
            cameraView.innerHTML = '<img id="captured-image" style="width:100%;height:100%;object-fit:contain;">';
            const img = document.getElementById('captured-image');
            img.src = canvas.toDataURL('image/png');
            
            // فعال کردن دکمه پردازش
            document.getElementById('process-camera').disabled = false;
            document.getElementById('status-text').textContent = 'تصویر با موفقیت گرفته شد. اکنون می‌توانید پردازش را آغاز کنید.';
        }
        
        function resetCamera() {
            stopCamera();
            document.getElementById('camera-view').innerHTML = '<p>برای شروع، دوربین را فعال کنید</p>';
            document.getElementById('status-text').textContent = 'آماده';
        }
        
        // توابع مربوط به آپلود فایل
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // نمایش تصویر آپلود شده در تب آپلود (برای اطمینان کاربر)
                    const uploadTab = document.getElementById('upload-tab');
                    let imgPreview = uploadTab.querySelector('#uploaded-image-preview');
                    if (!imgPreview) {
                        imgPreview = document.createElement('img');
                        imgPreview.id = 'uploaded-image-preview';
                        imgPreview.style.maxWidth = '100%';
                        imgPreview.style.maxHeight = '400px';
                        imgPreview.style.marginTop = '15px';
                        uploadTab.insertBefore(imgPreview, uploadTab.querySelector('.progress-container'));
                    }
                    imgPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                // فعال کردن دکمه پردازش
                document.getElementById('process-upload').disabled = false;
                document.getElementById('status-text-upload').textContent = 'تصویر با موفقیت آپلود شد. اکنون می‌توانید پردازش را آغاز کنید.';
            }
        }
        
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // تبدیل داده‌های Excel به فرمت پاسخ‌های صحیح
                        correctAnswers = {};
                        jsonData.forEach(row => {
                            const questionNum = Object.values(row)[0];
                            const correctAnswer = Object.values(row)[1];
                            if (questionNum && correctAnswer) {
                                correctAnswers[questionNum] = correctAnswer.toString().toUpperCase();
                            }
                        });
                        
                        console.log('پاسخ‌های صحیح بارگذاری شد:', correctAnswers);
                        alert(`فایل پاسخ‌های صحیح با ${Object.keys(correctAnswers).length} سوال بارگذاری شد.`);
                        
                        // به‌روزرسانی شبکه پاسخ‌های دستی
                        updateManualAnswersGrid();
                    } catch (err) {
                        console.error('خطا در خواندن فایل Excel:', err);
                        alert('خطا در خواندن فایل Excel. لطفاً فرمت فایل را بررسی کنید.');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        // توابع مربوط به پاسخ‌های دستی
        function setManualAnswers() {
            const start = parseInt(document.getElementById('manual-answer-start').value);
            const end = parseInt(document.getElementById('manual-answer-end').value);
            const value = document.getElementById('manual-answer-value').value.toUpperCase();
            
            if (isNaN(start) || isNaN(end) || start > end || start < 1 || end > settings.numQuestions) {
                alert('مقادیر وارد شده معتبر نیستند.');
                return;
            }
            
            if (!value.match(/^[A-D]$/)) {
                alert('لطفاً یک گزینه صحیح انتخاب کنید (فقط الف تا د).');
                return;
            }
            
            for (let i = start; i <= end; i++) {
                correctAnswers[i] = value;
            }
            
            alert(`پاسخ‌های سوالات ${start} تا ${end} به "${getPersianOption(value)}" تنظیم شد.`);
            updateManualAnswersGrid();
        }
        
        function clearManualAnswers() {
            if (confirm('آیا از پاک کردن همه پاسخ‌های صحیح اطمینان دارید؟')) {
                correctAnswers = {};
                updateManualAnswersGrid();
                alert('همه پاسخ‌های صحیح پاک شدند.');
            }
        }
        
        // تبدیل حروف انگلیسی به فارسی
        function getPersianOption(option) {
            const optionsMap = {
                'A': 'الف',
                'B': 'ب',
                'C': 'ج',
                'D': 'د'
            };
            return optionsMap[option] || option;
        }
        
        function createManualAnswersGrid() {
            const container = document.getElementById('manual-answers-container');
            container.innerHTML = '';
            
            for (let i = 1; i <= settings.numQuestions; i++) {
                const answerItem = document.createElement('div');
                answerItem.className = 'manual-answer-item';
                answerItem.innerHTML = `
                    <label for="answer-${i}">سوال ${i}</label>
                    <select id="answer-${i}" class="manual-answer-input" data-question="${i}">
                        <option value="">--</option>
                        <option value="A">الف</option>
                        <option value="B">ب</option>
                        <option value="C">ج</option>
                        <option value="D">د</option>
                    </select>
                `;
                container.appendChild(answerItem);
            }
            
            // افزودن رویداد تغییر به فیلدهای ورودی
            document.querySelectorAll('.manual-answer-input').forEach(select => {
                select.addEventListener('change', function() {
                    const questionNum = parseInt(this.getAttribute('data-question'));
                    const value = this.value.toUpperCase();
                    
                    if (value === '') {
                        delete correctAnswers[questionNum];
                    } else if (value.match(/^[A-D]$/)) {
                        correctAnswers[questionNum] = value;
                    }
                });
            });
        }
        
        function updateManualAnswersGrid() {
            document.querySelectorAll('.manual-answer-input').forEach(select => {
                const questionNum = parseInt(select.getAttribute('data-question'));
                select.value = correctAnswers[questionNum] || '';
            });
        }
        
        // توابع مربوط به پردازش تصویر با OCR
        async function processImage(source) {
            let imageSrc;
            const progressBar = source === 'camera' ? 
                document.getElementById('progress-bar') : 
                document.getElementById('progress-bar-upload');
            const statusText = source === 'camera' ? 
                document.getElementById('status-text') : 
                document.getElementById('status-text-upload');
            
            if (source === 'camera') {
                const capturedImage = document.getElementById('captured-image');
                if (!capturedImage) {
                    alert('لطفاً ابتدا تصویری از پاسخنامه بگیرید.');
                    return;
                }
                imageSrc = capturedImage.src;
            } else {
                const imageFile = document.getElementById('image-file').files[0];
                if (!imageFile) {
                    alert('لطفاً یک تصویر آپلود کنید.');
                    return;
                }
                imageSrc = URL.createObjectURL(imageFile);
            }
            
            if (Object.keys(correctAnswers).length === 0) {
                alert('لطفاً ابتدا پاسخ‌های صحیح را وارد کنید.');
                return;
            }
            
            // غیرفعال کردن دکمه پردازش
            if (source === 'camera') {
                document.getElementById('process-camera').disabled = true;
            } else {
                document.getElementById('process-upload').disabled = true;
            }
            
            // شروع پردازش OCR
            statusText.textContent = 'در حال پردازش تصویر...';
            progressBar.style.width = '10%';
            
            try {
                // استفاده از Tesseract.js برای OCR
                const { data: { text } } = await Tesseract.recognize(
                    imageSrc,
                    'fas+eng', // فارسی و انگلیسی
                    {
                        logger: progress => {
                            if (progress.status === 'recognizing text') {
                                const percent = Math.round(progress.progress * 100);
                                progressBar.style.width = `${10 + percent * 0.8}%`;
                                statusText.textContent = `در حال تشخیص متن: ${percent}%`;
                            }
                        }
                    }
                );
                
                progressBar.style.width = '95%';
                statusText.textContent = 'در حال تجزیه و تحلیل نتایج...';
                
                // تجزیه و تحلیل متن استخراج شده
                ocrResults = parseOCRText(text);
                
                // مقایسه با پاسخ‌های صحیح
                const comparisonResults = compareAnswers(ocrResults, correctAnswers);
                
                // نمایش نتایج
                displayResults(comparisonResults);
                
                progressBar.style.width = '100%';
                statusText.textContent = 'پردازش کامل شد!';
                
                // رفتن به تب نتایج
                document.querySelector('[data-tab="results"]').click();
                
            } catch (err) {
                console.error('خطا در پردازش OCR:', err);
                statusText.textContent = 'خطا در پردازش تصویر';
                alert('خطا در پردازش تصویر. لطفاً از وضوح تصویر اطمینان حاصل کنید.');
            }
        }
        
        // تجزیه و تحلیل متن استخراج شده توسط OCR
        function parseOCRText(text) {
            const results = {};
            // این یک الگوی ساده برای تشخیص پاسخ‌ها است
            // در عمل، این بخش باید بر اساس فرمت پاسخنامه واقعی سفارشی شود
            const lines = text.split('\n');
            
            lines.forEach(line => {
                // الگو: شماره سوال و سپس گزینه انتخابی
                const match = line.match(/(\d+)[:\-\s]*([A-D])/i);
                if (match) {
                    const questionNum = parseInt(match[1]);
                    const selectedAnswer = match[2].toUpperCase();
                    results[questionNum] = selectedAnswer;
                }
            });
            
            return results;
        }
        
        // مقایسه پاسخ‌های تشخیص داده شده با پاسخ‌های صحیح
        function compareAnswers(detected, correct) {
            const results = {
                correct: 0,
                wrong: 0,
                empty: 0,
                details: {}
            };
            
            for (let i = 1; i <= settings.numQuestions; i++) {
                const detectedAnswer = detected[i];
                const correctAnswer = correct[i];
                
                if (!detectedAnswer) {
                    results.details[i] = { status: 'empty', detected: '', correct: correctAnswer };
                    results.empty++;
                } else if (detectedAnswer === correctAnswer) {
                    results.details[i] = { status: 'correct', detected: detectedAnswer, correct: correctAnswer };
                    results.correct++;
                } else {
                    results.details[i] = { status: 'incorrect', detected: detectedAnswer, correct: correctAnswer };
                    results.wrong++;
                }
            }
            
            // محاسبه نمره
            results.score = (results.correct * settings.correctScore) + (results.wrong * settings.wrongScore);
            
            return results;
        }
        
        // نمایش نتایج
        function displayResults(results) {
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '';
            
            // خلاصه نتایج
            const summary = document.createElement('div');
            summary.className = 'results-summary';
            summary.innerHTML = `
                <h4>خلاصه نتایج:</h4>
                <div class="summary-grid">
                    <div>تعداد سوالات: <span>${settings.numQuestions}</span></div>
                    <div>پاسخ‌های صحیح: <span class="correct">${results.correct}</span></div>
                    <div>پاسخ‌های غلط: <span class="incorrect">${results.wrong}</span></div>
                    <div>پاسخ‌های خالی: <span class="empty">${results.empty}</span></div>
                    <div>نمره کل: <span>${results.score.toFixed(2)}</span></div>
                </div>
            `;
            resultsContainer.appendChild(summary);
            
            // جدول نتایج تفصیلی
            const table = document.createElement('table');
            table.className = 'results-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>شماره سوال</th>
                        <th>پاسخ تشخیص داده شده</th>
                        <th>پاسخ صحیح</th>
                        <th>وضعیت</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(results.details).map(qNum => {
                        const detail = results.details[qNum];
                        return `
                            <tr>
                                <td>${qNum}</td>
                                <td>${detail.detected || '---'}</td>
                                <td>${getPersianOption(detail.correct)}</td>
                                <td class="${detail.status}">${detail.status === 'correct' ? 'صحیح' : detail.status === 'incorrect' ? 'غلط' : 'خالی'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            resultsContainer.appendChild(table);
            
            // نمایش بخش نتایج
            document.getElementById('results-section').style.display = 'block';
            
            // به‌روزرسانی نمونه پاسخنامه
            updateAnswerSheetTemplate(results);
        }
        
        // چاپ نتایج
        function printResults() {
            window.print();
        }
        
        // چاپ پاسخنامه استاندارد
        function printStandardSheet() {
            // به‌روزرسانی پاسخنامه قابل چاپ
            createPrintableSheet();
            
            // چاپ فقط پاسخنامه استاندارد
            const originalContents = document.body.innerHTML;
            const printableSheet = document.querySelector('.printable-sheet').innerHTML;
            
            document.body.innerHTML = `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>پاسخنامه استاندارد</title>
                    <style>
                        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                        .a5-container { width: 148mm; height: 210mm; padding: 15mm; margin: 0 auto; background: white; box-sizing: border-box; }
                        .sheet-marker { position: absolute; width: 15px; height: 15px; background: black; border: 2px solid white; box-shadow: 0 0 0 2px black; z-index: 10; }
                        .sheet-marker.tl { top: 5mm; left: 5mm; } .sheet-marker.tr { top: 5mm; right: 5mm; }
                        .sheet-marker.bl { bottom: 5mm; left: 5mm; } .sheet-marker.br { bottom: 5mm; right: 5mm; }
                        .student-info { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px; font-size: 14px; }
                        .info-item { display: flex; align-items: center; } .info-item label { width: 100px; font-weight: bold; } .info-item span { flex: 1; border-bottom: 1px dashed #999; height: 20px; }
                        .questions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
                        .question-cell { text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-height: 60px; display: flex; flex-direction: column; justify-content: space-between; }
                        .question-number { font-weight: bold; margin-bottom: 8px; font-size: 16px; }
                        .option-bubbles { display: flex; justify-content: center; gap: 5px; }
                        .option-bubble { width: 20px; height: 20px; border: 1px solid #333; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; font-size: 12px; }
                        @media print { body { margin: 0; padding: 0; } .a5-container { box-shadow: none; margin: 0; width: 100%; height: 100%; } }
                    </style>
                </head>
                <body>
                    ${printableSheet}
                </body>
                </html>
            `;
            
            window.print();
            document.body.innerHTML = originalContents;
            
            // بازگرداندن رویدادها
            window.location.reload();
        }
        
        // خروجی Excel از نتایج
        function exportResults() {
            if (!ocrResults || Object.keys(ocrResults).length === 0) {
                alert('هیچ نتیجه‌ای برای ذخیره وجود ندارد.');
                return;
            }
            
            // ایجاد داده‌های Excel
            const data = [];
            
            // هدر
            data.push(['شماره سوال', 'پاسخ تشخیص داده شده', 'پاسخ صحیح', 'وضعیت']);
            
            // داده‌ها
            for (let i = 1; i <= settings.numQuestions; i++) {
                const detected = ocrResults[i] || '';
                const correct = correctAnswers[i] || '';
                const status = detected === correct ? 'صحیح' : (detected ? 'غلط' : 'خالی');
                
                data.push([i, detected, correct, status]);
            }
            
            // خلاصه نتایج
            data.push([]);
            data.push(['خلاصه نتایج', '', '', '']);
            data.push(['تعداد سوالات', settings.numQuestions, '', '']);
            data.push(['پاسخ‌های صحیح', Object.values(ocrResults).filter((val, idx) => val === correctAnswers[idx+1]).length, '', '']);
            data.push(['پاسخ‌های غلط', Object.values(ocrResults).filter((val, idx) => val && val !== correctAnswers[idx+1]).length, '', '']);
            data.push(['پاسخ‌های خالی', settings.numQuestions - Object.keys(ocrResults).length, '', '']);
            
            // ایجاد workbook و worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'نتایج تصحیح');
            
            // ذخیره فایل
            XLSX.writeFile(wb, 'نتایج_تصحیح_پاسخنامه.xlsx');
        }
        
        // مدیریت تنظیمات
        function loadSettings() {
            const savedSettings = localStorage.getItem('answerSheetSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
        }
        
        function saveSettings() {
            settings.numQuestions = parseInt(document.getElementById('num-questions').value) || 20;
            settings.optionsPerQuestion = parseInt(document.getElementById('options-per-question').value) || 4;
            settings.correctScore = parseFloat(document.getElementById('correct-score').value) || 1;
            settings.wrongScore = parseFloat(document.getElementById('wrong-score').value) || -0.25;
            
            localStorage.setItem('answerSheetSettings', JSON.stringify(settings));
            
            createAnswerSheetTemplate();
            createPrintableSheet();
            createStandardSheetPreview();
            createManualAnswersGrid();
            
            alert('تنظیمات با موفقیت ذخیره شد.');
        }
        
        function updateSettingsForm() {
            document.getElementById('num-questions').value = settings.numQuestions;
            document.getElementById('options-per-question').value = settings.optionsPerQuestion;
            document.getElementById('correct-score').value = settings.correctScore;
            document.getElementById('wrong-score').value = settings.wrongScore;
        }
        
        // ایجاد نمونه پاسخنامه
        function createAnswerSheetTemplate() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            const options = ['A', 'B', 'C', 'D'].slice(0, settings.optionsPerQuestion);
            
            for (let i = 1; i <= settings.numQuestions; i++) {
                const questionCell = document.createElement('div');
                questionCell.className = 'question-cell';
                questionCell.innerHTML = `
                    <div class="question-number">${i}</div>
                    <div class="option-bubbles">
                        ${options.map(opt => `<span class="option-bubble" data-question="${i}" data-option="${opt}">${getPersianOption(opt)}</span>`).join('')}
                    </div>
                `;
                container.appendChild(questionCell);
            }
            
            // به‌روزرسانی تعداد سوالات در خلاصه
            document.getElementById('total-questions').textContent = settings.numQuestions;
        }
        
        // ایجاد پاسخنامه قابل چاپ
        function createPrintableSheet() {
            const container = document.getElementById('printable-questions-container');
            container.innerHTML = '';
            
            const options = ['A', 'B', 'C', 'D'].slice(0, settings.optionsPerQuestion);
            
            for (let i = 1; i <= settings.numQuestions; i++) {
                const questionCell = document.createElement('div');
                questionCell.className = 'question-cell';
                questionCell.innerHTML = `
                    <div class="question-number">${i}</div>
                    <div class="option-bubbles">
                        ${options.map(opt => `<span class="option-bubble">${getPersianOption(opt)}</span>`).join('')}
                    </div>
                `;
                container.appendChild(questionCell);
            }
        }
        
        // ایجاد پیش‌نمایش پاسخنامه استاندارد
        function createStandardSheetPreview() {
            const container = document.getElementById('standard-sheet-preview');
            container.innerHTML = `
                <div style="text-align: center; margin: 20px 0;">
                    <p>پاسخنامه استاندارد شامل ${settings.numQuestions} سوال با ${settings.optionsPerQuestion} گزینه</p>
                    <div style="display: inline-block; border: 2px solid #333; padding: 20px; margin: 10px; background: white;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                            ${Array.from({length: Math.min(16, settings.numQuestions)}, (_, i) => `
                                <div style="text-align: center; border: 1px solid #ccc; padding: 5px;">
                                    <div style="font-weight: bold;">${i+1}</div>
                                    <div style="display: flex; justify-content: center; gap: 3px;">
                                        ${['A','B','C','D'].slice(0, settings.optionsPerQuestion).map(opt => 
                                            `<div style="width: 15px; height: 15px; border: 1px solid #000; border-radius: 50%;">${getPersianOption(opt)}</div>`
                                        ).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${settings.numQuestions > 16 ? `<p style="margin-top: 10px;">... و ${settings.numQuestions - 16} سوال دیگر</p>` : ''}
                    </div>
                    <p style="margin-top: 10px;">برای بهترین نتایج، از پاسخنامه با این فرمت استفاده کنید.</p>
                </div>
            `;
        }
        
        // به‌روزرسانی نمونه پاسخنامه با نتایج
        function updateAnswerSheetTemplate(results) {
            // حذف پرکردگی‌های قبلی
            document.querySelectorAll('.option-bubble.filled').forEach(bubble => {
                bubble.classList.remove('filled');
            });
            
            // پر کردن گزینه‌های تشخیص داده شده
            Object.keys(results.details).forEach(qNum => {
                const detail = results.details[qNum];
                if (detail.detected) {
                    const bubble = document.querySelector(`.option-bubble[data-question="${qNum}"][data-option="${detail.detected}"]`);
                    if (bubble) {
                        bubble.classList.add('filled');
                    }
                }
            });
            
            // به‌روزرسانی خلاصه نتایج
            document.getElementById('correct-count').textContent = results.correct;
            document.getElementById('wrong-count').textContent = results.wrong;
            document.getElementById('empty-count').textContent = results.empty;
            document.getElementById('total-score').textContent = results.score.toFixed(2);
            
            // نمایش نمونه پاسخنامه
            document.getElementById('answer-sheet-template').style.display = 'block';
        }
    </script>
</body>
</html>
